<svg viewBox="0 0 1400 1800" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font: bold 28px monospace; fill: #1a1a2e; }
      .subtitle { font: bold 18px monospace; fill: #16213e; }
      .code { font: 14px monospace; fill: #0f3460; }
      .label { font: 13px monospace; fill: #533483; }
      .address { font: 12px monospace; fill: #e94560; font-weight: bold; }
      .comment { font: 12px monospace; fill: #16a085; font-style: italic; }
      .arrow { stroke: #e94560; stroke-width: 3; fill: none; marker-end: url(#arrowhead); }
      .arrowup { stroke: #e94560; stroke-width: 3; fill: none; marker-end: url(#arrowheadup); }
      .pointer { stroke: #f39c12; stroke-width: 3; fill: none; }
      .box { stroke: #2c3e50; stroke-width: 2; }
      
      /* Colorful gradients */
      .grad1 { fill: url(#gradient1); }
      .grad2 { fill: url(#gradient2); }
      .grad3 { fill: url(#gradient3); }
      .grad4 { fill: url(#gradient4); }
      .grad5 { fill: url(#gradient5); }
    </style>
    
    <linearGradient id="gradient1" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#ff6b6b;stop-opacity:0.8" />
      <stop offset="100%" style="stop-color:#ee5a6f;stop-opacity:0.9" />
    </linearGradient>
    
    <linearGradient id="gradient2" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#4ecdc4;stop-opacity:0.8" />
      <stop offset="100%" style="stop-color:#44a08d;stop-opacity:0.9" />
    </linearGradient>
    
    <linearGradient id="gradient3" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#ffd93d;stop-opacity:0.8" />
      <stop offset="100%" style="stop-color:#f39c12;stop-opacity:0.9" />
    </linearGradient>
    
    <linearGradient id="gradient4" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#a8e6cf;stop-opacity:0.8" />
      <stop offset="100%" style="stop-color:#81c784;stop-opacity:0.9" />
    </linearGradient>
    
    <linearGradient id="gradient5" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#c7ceea;stop-opacity:0.8" />
      <stop offset="100%" style="stop-color:#9fa8da;stop-opacity:0.9" />
    </linearGradient>
    
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#e94560" />
    </marker>
    <marker id="arrowheadup" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 6, 10 3, 0 0" fill="#e94560" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="700" y="35" text-anchor="middle" class="title">üéØ ARM Stack Frame - Complete Lifecycle (PROLOGUE ‚Üí EPILOGUE)</text>
  <text x="700" y="60" text-anchor="middle" class="comment">(Full Descending Stack: SP decreases, grows from HIGH to LOW addresses)</text>

  <!-- ===================== STEP 1 ===================== -->
  <g id="step1">
    <rect x="30" y="90" width="350" height="220" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2" rx="10"/>
    <text x="205" y="115" text-anchor="middle" class="subtitle">üìç Step 1: _start calls max</text>
    
    <!-- Code -->
    <rect x="50" y="130" width="310" height="160" fill="#ffffff" stroke="#adb5bd" stroke-width="1" rx="5"/>
    <text x="70" y="155" class="code" fill="#e94560">_start:</text>
    <text x="85" y="180" class="code">mov r0, #10</text>
    <text x="85" y="205" class="code">mov r1, #20</text>
    <text x="85" y="230" class="code" font-weight="bold" fill="#2ecc71">bl max</text>
    <text x="100" y="255" class="comment">‚Üê About to call max!</text>
    <text x="85" y="275" class="code">bkpt</text>
    
    <!-- Stack -->
    <g transform="translate(450, 100)">
      <text x="150" y="0" text-anchor="middle" class="subtitle">üìö Stack Memory</text>
      
      <!-- Low address at top -->
      <text x="10" y="40" class="address">0x1000</text>
      <rect x="80" y="25" width="220" height="40" class="box" fill="#ecf0f1" opacity="0.3"/>
      <text x="190" y="50" text-anchor="middle" class="label" opacity="0.5">‚Üê LOW ADDRESS</text>
      
      <line x1="190" y1="95" x2="190" y2="75" class="arrowup"/>
      <text x="310" y="90" class="comment">Stack grows UP ‚¨Ü</text>
      <text x="310" y="120" class="comment">Address increase DOWN ‚¨á</text>
      
      <text x="10" y="120" class="address">0x1FF8</text>
      <rect x="80" y="105" width="220" height="50" class="box grad5"/>
      <text x="190" y="135" text-anchor="middle" class="code">(Empty - ready for max)</text>
      
      <!-- SP pointer -->
      <line x1="65" y1="130" x2="80" y2="130" class="pointer"/>
      <text x="15" y="138" class="label" fill="#f39c12" font-weight="bold">SP ‚Üí</text>
      
      <text x="10" y="185" class="address">0x2000</text>
      <rect x="80" y="165" width="220" height="50" class="box grad5"/>
      <text x="190" y="195" text-anchor="middle" class="code">‚Üê HIGH ADDRESS (bottom)</text>
    </g>
  </g>
  <line x1="20" y1="340" x2="920" y2="340" class="pointer"/>
  <!-- ===================== STEP 2 ===================== -->
  <g id="step2" transform="translate(0, 40)">
    <rect x="30" y="340" width="350" height="260" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2" rx="10"/>
    <text x="205" y="365" text-anchor="middle" class="subtitle">üìç Step 2: max PROLOGUE ‚ö°</text>
    
    <!-- Code -->
    <rect x="50" y="380" width="310" height="200" fill="#ffffff" stroke="#adb5bd" stroke-width="1" rx="5"/>
    <text x="70" y="405" class="code" fill="#e94560">max:</text>
    <text x="85" y="430" class="code" font-weight="bold" fill="#e74c3c">push {r11, lr}</text>
    <text x="100" y="450" class="comment">Save FP + Return address</text>
    
    <text x="85" y="475" class="code" font-weight="bold" fill="#3498db">mov r11, sp</text>
    <text x="100" y="495" class="comment">Set new Frame Pointer</text>
    
    <text x="85" y="520" class="code" font-weight="bold" fill="#9b59b6">sub sp, sp, #16</text>
    <text x="100" y="540" class="comment">Reserve 16 bytes for locals</text>
    
    <text x="85" y="565" class="code">bl min</text>
    
    <!-- Stack -->
    <g transform="translate(450, 345)">
      <text x="150" y="0" text-anchor="middle" class="subtitle">üìö Stack After Prologue</text>
      
      <!-- Low addresses at top -->
      <text x="10" y="40" class="address">0x1000</text>
      <rect x="80" y="25" width="220" height="35" class="box" fill="#ecf0f1" opacity="0.3"/>
      <text x="190" y="47" text-anchor="middle" class="label" opacity="0.5">‚Üê LOW ADDRESS</text>
      
      <!-- Local space (grows downward) -->
      <text x="10" y="85" class="address">0x1FE0</text>
      <rect x="80" y="70" width="220" height="70" class="box grad3"/>
      <text x="190" y="95" text-anchor="middle" class="code" font-weight="bold">16 bytes LOCAL SPACE</text>
      <text x="190" y="115" text-anchor="middle" class="label">(for max's variables)</text>
      <text x="190" y="130" text-anchor="middle" class="comment">Created by sub sp, #16</text>
      
      <!-- SP points here -->
      <line x1="65" y1="70" x2="80" y2="70" class="pointer"/>
      <text x="5" y="78" class="label" fill="#f39c12" font-weight="bold">SP ‚Üí</text>
      <text x="320" y="78" class="label">‚Üê Current top</text>
      
      <!-- Old r11 saved -->
      <text x="10" y="165" class="address">0x1FF0</text>
      <rect x="80" y="150" width="220" height="45" class="box grad2"/>
      <text x="190" y="170" text-anchor="middle" class="code" font-weight="bold">old r11 (FP)</text>
      <text x="190" y="185" text-anchor="middle" class="label" fill="#fff">Saved by push!</text>
      
      <!-- FP points here -->
      <line x1="65" y1="150" x2="80" y2="150" class="pointer"/>
      <text x="5" y="158" class="label" fill="#f39c12" font-weight="bold">FP ‚Üí</text>
      
      <!-- LR saved -->
      <text x="10" y="220" class="address">0x1FF4</text>
      <rect x="80" y="205" width="220" height="45" class="box grad1"/>
      <text x="190" y="225" text-anchor="middle" class="code" font-weight="bold">LR (return to _start)</text>
      <text x="190" y="240" text-anchor="middle" class="label" fill="#fff">Saved by push!</text>
      
      <!-- High addresses at bottom -->
      <text x="10" y="275" class="address">0x2000</text>
      <rect x="80" y="260" width="220" height="35" class="box grad5" opacity="0.3"/>
      <text x="190" y="282" text-anchor="middle" class="label" opacity="0.5">‚Üê HIGH ADDRESS</text>
    </g>
  </g>
  <line x1="20" y1="700" x2="920" y2="700" class="pointer"/>
  <!-- ===================== STEP 3 ===================== -->
  <g id="step3" transform="translate(0, 100)">
    <rect x="30" y="630" width="350" height="240" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2" rx="10"/>
    <text x="205" y="655" text-anchor="middle" class="subtitle">üìç Step 3: min PROLOGUE ‚ö°</text>
    
    <!-- Code -->
    <rect x="50" y="670" width="310" height="180" fill="#ffffff" stroke="#adb5bd" stroke-width="1" rx="5"/>
    <text x="70" y="695" class="code" fill="#e94560">min:</text>
    <text x="85" y="720" class="code" font-weight="bold" fill="#e74c3c">push {r11}</text>
    <text x="100" y="740" class="comment">Save max's Frame Pointer</text>
    
    <text x="85" y="765" class="code" font-weight="bold" fill="#3498db">mov r11, sp</text>
    <text x="100" y="785" class="comment">Set min's Frame Pointer</text>
    
    <text x="85" y="810" class="code" font-weight="bold" fill="#9b59b6">sub sp, sp, #8</text>
    <text x="100" y="830" class="comment">Reserve 8 bytes (aligned!)</text>
    
    <!-- Stack -->
    <g transform="translate(450, 675)">
      <text x="150" y="0" text-anchor="middle" class="subtitle">üìö Stack During min</text>
      
      <!-- Low addresses at top -->
      <text x="10" y="35" class="address">0x1000</text>
      <rect x="80" y="20" width="220" height="25" class="box" fill="#ecf0f1" opacity="0.3"/>
      <text x="190" y="37" text-anchor="middle" class="label" opacity="0.5">LOW ADDRESS</text>
      
      <!-- min's locals -->
      <text x="10" y="70" class="address">0x1FD4</text>
      <rect x="80" y="55" width="220" height="50" class="box grad3"/>
      <text x="190" y="75" text-anchor="middle" class="code" font-weight="bold">8 bytes LOCAL</text>
      <text x="190" y="93" text-anchor="middle" class="label">(min's variables)</text>
      
      <!-- SP -->
      <line x1="65" y1="55" x2="80" y2="55" class="pointer"/>
      <text x="5" y="63" class="label" fill="#f39c12" font-weight="bold">SP ‚Üí</text>
      <text x="320" y="63" class="label">‚Üê Lowest address</text>
      
      <!-- min's saved FP -->
      <text x="10" y="130" class="address">0x1FDC</text>
      <rect x="80" y="115" width="220" height="45" class="box grad4"/>
      <text x="190" y="135" text-anchor="middle" class="code" font-weight="bold">max's r11 (saved)</text>
      <text x="190" y="150" text-anchor="middle" class="label" fill="#fff">push {r11}</text>
      
      <!-- min's FP -->
      <line x1="65" y1="115" x2="80" y2="115" class="pointer"/>
      <text x="5" y="123" class="label" fill="#f39c12" font-weight="bold">FP ‚Üí</text>
      
      <!-- Previous frames (faded) -->
      <text x="10" y="185" class="address">0x1FE0</text>
      <rect x="80" y="170" width="220" height="35" class="box grad3" opacity="0.3"/>
      <text x="190" y="192" text-anchor="middle" class="label" opacity="0.5">max's locals (16B)</text>
      
      <text x="10" y="225" class="address">0x1FF0</text>
      <rect x="80" y="210" width="220" height="35" class="box grad2" opacity="0.3"/>
      <text x="190" y="232" text-anchor="middle" class="label" opacity="0.5">max's old r11</text>
      
      <text x="10" y="265" class="address">0x1FF4</text>
      <rect x="80" y="250" width="220" height="35" class="box grad1" opacity="0.3"/>
      <text x="190" y="272" text-anchor="middle" class="label" opacity="0.5">LR ‚Üí _start</text>
      
      <text x="10" y="305" class="address">0x2000</text>
      <rect x="80" y="290" width="220" height="25" class="box grad5" opacity="0.3"/>
      <text x="190" y="307" text-anchor="middle" class="label" opacity="0.5">HIGH ADDRESS</text>
    </g>
  </g>
  <line x1="20" y1="1120" x2="920" y2="1120" class="pointer"/>
  <!-- ===================== STEP 4: min EPILOGUE (Corrected) ===================== -->
  <g id="step4" transform="translate(0, 290)">
    <rect x="30" y="900" width="350" height="240" fill="#fff3cd" stroke="#ffc107" stroke-width="3" rx="10"/>
    <text x="205" y="925" text-anchor="middle" class="subtitle">üìç Step 4: min EPILOGUE üîÑ</text>
    
    <!-- Code -->
    <rect x="50" y="940" width="310" height="180" fill="#ffffff" stroke="#adb5bd" stroke-width="1" rx="5"/>
    <text x="70" y="965" class="code" fill="#e94560">min: (returning)</text>
    <text x="85" y="990" class="code">cmp r0, r1</text>
    <text x="85" y="1010" class="code">movlt r0, #0</text>
    
    <text x="85" y="1040" class="code" font-weight="bold" fill="#9b59b6">mov sp, r11</text>
    <text x="100" y="1060" class="comment">Restore SP (free locals)</text>
    
    <text x="85" y="1085" class="code" font-weight="bold" fill="#e74c3c">pop {r11}</text>
    <text x="100" y="1105" class="comment">Restore saved FP</text>
    
    <!-- Stack -->
    <g transform="translate(450, 905)">
      <text x="150" y="0" text-anchor="middle" class="subtitle">üìö Stack After min Epilogue</text>
      
      <!-- Freed space -->
      <text x="10" y="40" class="address">0x1FD4</text>
      <rect x="80" y="25" width="220" height="60" class="box" fill="#d4edda" stroke="#28a745" stroke-dasharray="5,5"/>
      <text x="190" y="55" text-anchor="middle" class="comment">‚úì min's frame freed!</text>
      <text x="190" y="70" text-anchor="middle" class="comment">State restored to before min call</text>
      
      <!-- max's locals visible again -->
      <text x="10" y="110" class="address">0x1FE0</text>
      <rect x="80" y="95" width="220" height="55" class="box grad3"/>
      <text x="190" y="117" text-anchor="middle" class="code" font-weight="bold">max's locals (16B)</text>
      <text x="190" y="135" text-anchor="middle" class="comment">‚Üë Top of stack</text>
      
      <!-- SP back to top of max's frame -->
      <line x1="65" y1="95" x2="80" y2="95" class="pointer"/>
      <text x="25" y="103" class="label" fill="#f39c12" font-weight="bold">SP ‚Üí</text>
      
      <!-- max's saved FP -->
      <text x="10" y="175" class="address">0x1FF0</text>
      <rect x="80" y="160" width="220" height="35" class="box grad2"/>
      <text x="190" y="182" text-anchor="middle" class="label">max's old r11</text>
      
      <!-- FP back to max's frame base-->
      <line x1="65" y1="160" x2="80" y2="160" class="pointer"/>
      <text x="25" y="168" class="label" fill="#f39c12" font-weight="bold">FP ‚Üí</text>

      <!-- max's saved LR -->
      <text x="10" y="215" class="address">0x1FF4</text>
      <rect x="80" y="200" width="220" height="35" class="box grad1"/>
      <text x="190" y="222" text-anchor="middle" class="label">LR ‚Üí max</text>
    </g>
  </g>
  <line x1="20" y1="1460" x2="920" y2="1460" class="pointer"/>
  <!-- ===================== STEP 5: max EPILOGUE ===================== -->
  <g id="step5" transform="translate(0, 330)">
    <rect x="30" y="1170" width="350" height="240" fill="#d1ecf1" stroke="#17a2b8" stroke-width="3" rx="10"/>
    <text x="205" y="1195" text-anchor="middle" class="subtitle">üìç Step 5: max EPILOGUE üîÑ</text>
    
    <!-- Code -->
    <rect x="50" y="1210" width="310" height="180" fill="#ffffff" stroke="#adb5bd" stroke-width="1" rx="5"/>
    <text x="70" y="1235" class="code" fill="#e94560">max: (returning)</text>
    <text x="85" y="1260" class="code">cmp r0, r1</text>
    <text x="85" y="1280" class="code">movge r0, #1</text>
    
    <text x="85" y="1310" class="code" font-weight="bold" fill="#9b59b6">mov sp, r11</text>
    <text x="100" y="1330" class="comment">Restore SP (free 16B locals)</text>
    
    <text x="85" y="1355" class="code" font-weight="bold" fill="#e74c3c">pop {r11, lr}</text>
    <text x="100" y="1375" class="comment">Restore FP + return address</text>
    
    <!-- Stack -->
    <g transform="translate(450, 1175)">
      <text x="150" y="0" text-anchor="middle" class="subtitle">üìö Stack After max Epilogue</text>
      
      <!-- Stack clean! -->
      <text x="10" y="40" class="address">0x1000</text>
      <rect x="80" y="25" width="220" height="40" class="box" fill="#ecf0f1" opacity="0.3"/>
      <text x="190" y="50" text-anchor="middle" class="label" opacity="0.5">‚Üê LOW ADDRESS</text>
      
      <!-- Freed space -->
      <rect x="80" y="75" width="220" height="80" class="box" fill="#d4edda" stroke="#28a745" stroke-dasharray="5,5"/>
      <text x="190" y="105" text-anchor="middle" class="comment" font-weight="bold">‚úì‚úì ALL FRAMES CLEANED!</text>
      <text x="190" y="125" text-anchor="middle" class="comment">bx lr ‚Üí back to _start</text>
      <text x="190" y="145" text-anchor="middle" class="comment">Perfect symmetry restored!</text>
      
      <text x="10" y="180" class="address">0x1FF8</text>
      <rect x="80" y="165" width="220" height="50" class="box grad5"/>
      <text x="190" y="195" text-anchor="middle" class="code">‚úì Clean! Back to _start</text>
      
      <!-- SP restored -->
      <line x1="65" y1="190" x2="80" y2="190" class="pointer"/>
      <text x="15" y="198" class="label" fill="#f39c12" font-weight="bold">SP ‚Üí</text>
      
      <text x="10" y="240" class="address">0x2000</text>
      <rect x="80" y="225" width="220" height="40" class="box grad5"/>
      <text x="190" y="250" text-anchor="middle" class="code">‚Üê HIGH ADDRESS</text>
    </g>
  </g>
  <line x1="20" y1="1800" x2="920" y2="1800" class="pointer"/>
  <!-- ===================== LEGEND ===================== -->
  <g transform="translate(950, 90)">
    <rect x="-20" y="-20" width="340" height="620" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2" rx="10"/>
    <text x="140" y="10" text-anchor="middle" class="subtitle">üé® Legend &amp; Rules</text>
    
    <!-- Color legend -->
    <rect x="10" y="30" width="40" height="25" class="box grad1"/>
    <text x="60" y="47" class="label">LR (Link Register)</text>
    
    <rect x="10" y="65" width="40" height="25" class="box grad2"/>
    <text x="60" y="82" class="label">Saved r11 (old FP)</text>
    
    <rect x="10" y="100" width="40" height="25" class="box grad3"/>
    <text x="60" y="117" class="label">Local variables</text>
    
    <rect x="10" y="135" width="40" height="25" class="box grad4"/>
    <text x="60" y="152" class="label">Nested frame data</text>
    
    <rect x="10" y="170" width="40" height="25" class="box" fill="#d4edda" stroke="#28a745" stroke-dasharray="5,5"/>
    <text x="60" y="187" class="label">Freed/cleaned space</text>
    
    <!-- Rules -->
    <text x="10" y="220" class="code" font-weight="bold" fill="#e94560">‚ö° PROLOGUE (Enter):</text>
    <text x="20" y="240" class="label">1. push {r11, lr}</text>
    <text x="20" y="260" class="label">2. mov r11, sp</text>
    <text x="20" y="280" class="label">3. sub sp, sp, #N</text>
    <text x="20" y="300" class="comment">‚Üí SP DECREASES (grows down)</text>
    
    <text x="10" y="330" class="code" font-weight="bold" fill="#27ae60">üîÑ EPILOGUE (Exit):</text>
    <text x="20" y="350" class="label">1. mov sp, r11</text>
    <text x="20" y="370" class="label">2. pop {r11, lr}</text>
    <text x="20" y="390" class="label">3. bx lr</text>
    <text x="20" y="410" class="comment">‚Üí SP INCREASES (shrinks up)</text>
    
    <text x="10" y="440" class="code" font-weight="bold" fill="#8e44ad">üìå Key Points:</text>
    <text x="20" y="460" class="label">‚Ä¢ Stack = Full Descending</text>
    <text x="20" y="480" class="label">‚Ä¢ Low addr (top) ‚Üí High addr (bot)</text>
    <text x="20" y="500" class="label">‚Ä¢ Push: SP = SP - 4</text>
    <text x="20" y="520" class="label">‚Ä¢ Pop: SP = SP + 4</text>
    <text x="20" y="540" class="label">‚Ä¢ FP = anchor (stable)</text>
    <text x="20" y="560" class="label">‚Ä¢ SP = moves (dynamic)</text>
    <text x="20" y="580" class="label" font-weight="bold" fill="#e74c3c">‚Ä¢ MIRROR symmetry!</text>
  </g>
  <!-- Bottom Arrow showing flow -->
  <g transform="translate(950, 730)">
    <text x="140" y="0" text-anchor="middle" class="subtitle">üîÑ Call Flow</text>
    <rect x="10" y="15" width="260" height="50" fill="#e8f5e9" stroke="#4caf50" stroke-width="2" rx="5"/>
    <text x="140" y="40" text-anchor="middle" class="code">_start ‚Üí max ‚Üí min</text>
    <text x="140" y="55" text-anchor="middle" class="comment" font-size="10">(SP goes DOWN)</text>
    
    <line x1="140" y1="75" x2="140" y2="95" class="arrow"/>
    
    <rect x="10" y="100" width="260" height="50" fill="#fff3e0" stroke="#ff9800" stroke-width="2" rx="5"/>
    <text x="140" y="125" text-anchor="middle" class="code">min returns ‚Üí max returns</text>
    <text x="140" y="140" text-anchor="middle" class="comment" font-size="10">(SP goes UP)</text>
    
    <line x1="140" y1="160" x2="140" y2="180" class="arrow"/>
    
    <rect x="10" y="185" width="260" height="50" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="5"/>
    <text x="140" y="210" text-anchor="middle" class="code">back to _start (clean!)</text>
    <text x="140" y="225" text-anchor="middle" class="comment" font-size="10">(SP back to original)</text>
  </g>
</svg>