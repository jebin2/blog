<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Dynamic Markdown Blog</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

	<!-- External Themes: Complete styling controlled by these files -->
	<link class="theme" id="theme1" rel="stylesheet" href="style/style1.css" disabled>
	<link class="theme" id="theme2" rel="stylesheet" href="style/style2.css">
	<link class="theme" id="theme3" rel="stylesheet" href="style/style3.css" disabled>
	<link class="theme" id="theme4" rel="stylesheet" href="style/style4.css" disabled>
	<link class="theme" id="theme5" rel="stylesheet" href="style/style5.css" disabled>
	<link class="theme" id="theme6" rel="stylesheet" href="style/style6.css" disabled>
	<link class="theme" id="theme7" rel="stylesheet" href="style/style7.css" disabled>
	<link class="theme" id="theme8" rel="stylesheet" href="style/style8.css" disabled>
	<link class="theme" id="theme9" rel="stylesheet" href="style/style9.css" disabled>
</head>

<body>
	<!-- Decorative corners for themes that want them -->
	<div class="corner corner-top-left"></div>
	<div class="corner corner-top-right"></div>
	<div class="corner corner-bottom-left"></div>
	<div class="corner corner-bottom-right"></div>

	<!-- Progress indicator -->
	<div class="progress-bar"></div>

	<!-- Fixed navigation controls -->
	<div class="controls">
		<button class="button button-home" onclick="window.location.href=window.location.pathname">
			<span class="button-icon">üè†</span>
			<span class="button-label">Home</span>
		</button>
		<div class="dropdown">
			<div class="dropdown-trigger" id="themeLabel">
				<span class="dropdown-icon">üé®</span>
				<span class="dropdown-label">Select Theme</span>
			</div>
			<div class="dropdown-menu"></div>
		</div>
	</div>

	<!-- Main content wrapper -->
	<main class="wrapper" id="content">
		<div class="page page-main">
			
			<!-- Window decoration wrapper -->
			<div class="window">
				<div class="window-titlebar">
					<span class="window-title">BLOG.EXE</span>
					<div class="window-buttons">
						<span class="window-button window-button-minimize">‚îÄ</span>
						<span class="window-button window-button-maximize">‚ñ°</span>
						<span class="window-button window-button-close">‚úï</span>
					</div>
				</div>
			</div>

			<!-- Header section -->
			<header class="header">
				<div class="header-decoration-top"></div>
				<h1 class="title title-main">Dive-In</h1>
				<p class="subtitle">Welcome Seeker</p>
				<div class="header-decoration-bottom"></div>
			</header>

			<!-- Separator -->
			<div class="separator separator-header"></div>

			<!-- Content sections -->
			<section class="content">
				
				<!-- SVG/Infographics category -->
				<div class="category category-infographics">
					<a href="svgs/view.html" target="_blank" class="link">
						<h2 class="title title-category" id="svg_head">
							<span class="title-icon">üé®</span>
							<span class="title-text">Infographics</span>
							<span class="title-count"></span>
						</h2>
					</a>
				</div>

				<div class="separator separator-category"></div>

				<!-- Posts category -->
				<div class="category category-posts">
					<h2 class="title title-category" id="post_title">
						<span class="title-icon">üìö</span>
						<span class="title-text">Posts</span>
						<span class="title-count"></span>
					</h2>
					<div class="grid"></div>
				</div>
			</section>

			<div class="separator separator-footer"></div>

			<!-- Footer -->
			<footer class="footer">
				<div class="footer-decoration-top"></div>
				<p class="text text-footer">Made by Learning</p>
				<div class="footer-decoration-bottom"></div>
			</footer>
		</div>
	</main>

	<!-- Status bar for themes that want it -->
	<div class="statusbar">
		<span class="statusbar-item statusbar-left">Ready</span>
		<span class="statusbar-item statusbar-center"></span>
		<span class="statusbar-item statusbar-right" id="statusTime"></span>
	</div>

	<!-- Image modal -->
	<div class="modal modal-image" id="imageModal">
		<div class="modal-overlay"></div>
		<div class="modal-container">
			<button class="modal-close">
				<span class="modal-close-icon">√ó</span>
			</button>
			<div class="modal-content" id="modalImageContainer"></div>
		</div>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', () => {

			// Update status time
			const updateStatusTime = () => {
				const statusTime = document.getElementById('statusTime');
				if (statusTime) {
					const now = new Date();
					statusTime.textContent = now.toLocaleTimeString('en-US', { hour12: false });
				}
			};
			updateStatusTime();
			setInterval(updateStatusTime, 1000);

			// DOM references
			const contentArea = document.getElementById('content');
			const progressBar = document.querySelector('.progress-bar');
			const imageModal = document.getElementById('imageModal');
			const modalImageContainer = document.getElementById('modalImageContainer');

			// Initialize
			const init = () => {
				setupThemeSwitcher();
				setupImageModalControls();
				router();
			};

			// Route to correct page
			const router = () => {
				const page = new URLSearchParams(window.location.search).get('page');
				if (page) {
					loadMarkdownPage(page);
				} else {
					loadMainPage();
				}
			};

			// Render state
			const renderState = (html) => {
				contentArea.innerHTML = html;
			};

			// Load markdown page
			const loadMarkdownPage = async (page) => {
				renderState('<div class="message message-loading">Loading...</div>');
				try {
					const response = await fetch(`https://raw.githubusercontent.com/jebin2/blog/main/${page}`);
					if (!response.ok) throw new Error('Markdown file not found');
					const md = await response.text();
					contentArea.innerHTML = marked.parse(md);
					setupPageSpecificFeatures();
				} catch (err) {
					renderState(`<div class="message message-error">Error: ${err.message}</div>`);
				}
			};

			// Load main page with posts
			const loadMainPage = async () => {
				const categoryTitleEl = document.querySelector('#post_title');
				const svgTitleEl = document.querySelector('#svg_head');
				const gridEl = document.querySelector('.grid');

				const postsText = categoryTitleEl.querySelector('.title-text');
				const postsCount = categoryTitleEl.querySelector('.title-count');
				const svgText = svgTitleEl.querySelector('.title-text');
				const svgCount = svgTitleEl.querySelector('.title-count');

				if (postsText) postsText.textContent = 'Loading...';
				gridEl.innerHTML = '<div class="message message-loading">Loading blog posts...</div>';

				try {
					const response = await fetch('manifest.json');
					if (!response.ok) throw new Error('manifest.json not found');
					const manifest = await response.json();
					if (!manifest.posts || manifest.posts.length === 0) {
						throw new Error('No posts found');
					}

					const posts = manifest.posts.sort((a, b) => new Date(b.date) - new Date(a.date));
					const svgs = manifest.svgs.sort((a, b) => new Date(b.date) - new Date(a.date));

					if (postsText) postsText.textContent = 'Posts';
					if (svgText) svgText.textContent = 'Infographics';
					if (postsCount) postsCount.textContent = `(${posts.length})`;
					if (svgCount) svgCount.textContent = `(${svgs.length})`;

					gridEl.innerHTML = posts.map(post => {
						const cleanName = post.title || post.path.split('/').pop().replace('.md', '');
						const date = new Date(post.date).toLocaleDateString();
						return `
                <article class="card">
                    <div class="card-decoration card-decoration-top"></div>
                    <h3 class="card-title">${cleanName}</h3>
                    <div class="card-path">${post.path}</div>
                    <div class="card-meta">
                        <span class="card-date">üìÖ ${date}</span>
                    </div>
                    <div class="card-actions">
                        <button class="button button-read" data-path="${post.path}">
                            <span class="button-label">Read Post</span>
                            <span class="button-icon">‚Üí</span>
                        </button>
                    </div>
                    <div class="card-decoration card-decoration-bottom"></div>
                </article>`;
					}).join('');

					setupBlogLinks();
				} catch (error) {
					if (postsText) postsText.textContent = 'Error';
					gridEl.innerHTML = `<div class="message message-error">Error: ${error.message}</div>`;
				}
			};

			// Setup blog card click handlers
			const setupBlogLinks = () => {
				document.querySelectorAll('[data-path]').forEach(el => {
					el.addEventListener('click', (e) => {
						const path = el.getAttribute('data-path');
						window.location.href = `${window.location.pathname}?page=${path}`;
					});
				});
			};

			// Setup page-specific features
			const setupPageSpecificFeatures = () => {
				setupScrollProgressBar();
				setupImagePopups();
			};

			// Scroll progress bar
			const setupScrollProgressBar = () => {
				window.addEventListener('scroll', () => {
					const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
					const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
					const scrollPercent = height > 0 ? (winScroll / height) * 100 : 0;
					progressBar.style.width = `${scrollPercent}%`;
				}, { passive: true });
			};

			// Theme switcher
			const setupThemeSwitcher = () => {
				const themeLinks = document.querySelectorAll('link.theme');
				const dropdownMenu = document.querySelector('.dropdown-menu');
				const themeLabel = document.getElementById('themeLabel');

				dropdownMenu.innerHTML = '';

				themeLinks.forEach((link, index) => {
					const themeId = link.id;
					const option = document.createElement('div');
					option.className = 'dropdown-item';
					option.innerHTML = `
						<span class="dropdown-item-icon">üé®</span>
						<span class="dropdown-item-label">Theme ${index + 1}</span>
					`;
					option.addEventListener('click', () => applyTheme(themeId));
					dropdownMenu.appendChild(option);
				});

				const applyTheme = (themeId) => {
					themeLinks.forEach(link => link.disabled = (link.id !== themeId));
					const option = dropdownMenu.querySelector(`[data-theme="${themeId}"]`);
					localStorage.setItem('selectedTheme', themeId);
					document.body.className = `theme-${themeId}`;
				};

				const savedTheme = localStorage.getItem('selectedTheme') || themeLinks[4].id;
				applyTheme(savedTheme);
			};

			// Image modal controls
			const setupImageModalControls = () => {
				const closeBtn = imageModal.querySelector('.modal-close');
				const overlay = imageModal.querySelector('.modal-overlay');
				
				closeBtn.addEventListener('click', closeImageModal);
				overlay.addEventListener('click', closeImageModal);
				
				document.addEventListener('keydown', (e) => {
					if (e.key === 'Escape') closeImageModal();
				});
			};

			// Image popup on click
			const setupImagePopups = () => {
				contentArea.querySelectorAll('img').forEach(img => {
					img.style.cursor = 'pointer';
					img.addEventListener('click', () => openImageModal(img.src, img.alt));
				});
			};

			// Open image modal
			const openImageModal = (src, altText) => {
				imageModal.classList.add('modal-open');
				document.body.style.overflow = 'hidden';
				modalImageContainer.innerHTML = '<div class="spinner"></div>';

				const modalImg = new Image();
				modalImg.className = 'image';
				modalImg.alt = altText || 'Blog image';
				
				modalImg.onload = () => {
					modalImageContainer.innerHTML = '';
					modalImageContainer.appendChild(modalImg);
					if (altText) {
						const caption = document.createElement('div');
						caption.className = 'image-caption';
						caption.textContent = altText;
						modalImageContainer.appendChild(caption);
					}
				};
				
				modalImg.onerror = () => {
					modalImageContainer.innerHTML = '<div class="message message-error">Failed to load image</div>';
				};
				
				modalImg.src = src;
			};

			// Close image modal
			const closeImageModal = () => {
				imageModal.classList.remove('modal-open');
				document.body.style.overflow = 'auto';
			};

			// Start application
			init();
		});
	</script>

</body>

</html>